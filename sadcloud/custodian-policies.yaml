policies:
  - name: check-s3-bucket-global-grants
    resource: s3
    description: Check for S3 buckets with global grants
    filters:
      - type: global-grants
    actions:
      - type: set-public-block
        BlockPublicAcls: true
        IgnorePublicAcls: true
        BlockPublicPolicy: true
        RestrictPublicBuckets: true
      - type: notify
        to:
          - slack
        transport:
          type: slack
          url: ${SLACK_WEBHOOK_URL}
        subject: "S3 Bucket Privacy Alert: Global Grants Removed"
        message: |
          S3 bucket {resource[BucketName]} in account {account_id} 
          had global grants which have been removed.

  - name: check-s3-bucket-public-block
    resource: s3
    description: Check for S3 buckets without proper public access blocks
    filters:
      - type: check-public-block
        BlockPublicAcls: false
        BlockPublicPolicy: false
    actions:
      - type: set-public-block
        BlockPublicAcls: true
        IgnorePublicAcls: true
        BlockPublicPolicy: true
        RestrictPublicBuckets: true
      - type: notify
        to:
          - slack
        transport:
          type: slack
          url: ${SLACK_WEBHOOK_URL}
        subject: "S3 Bucket Privacy Alert: Public Access Block Enabled"
        message: |
          S3 bucket {resource[BucketName]} in account {account_id} 
          had public access blocks disabled. They have now been enabled.

  - name: check-s3-bucket-policy
    resource: s3
    description: Check for S3 buckets with public access in their policy
    filters:
      - type: has-statement
        statement:
          - Effect: Allow
            Principal: "*"
            Action: "s3:*"
    actions:
      - type: remove-statements
        statement_ids:
          - PublicAccess
      - type: notify
        to:
          - slack
        transport:
          type: slack
          url: ${SLACK_WEBHOOK_URL}
        subject: "S3 Bucket Privacy Alert: Public Policy Removed"
        message: |
          S3 bucket {resource[BucketName]} in account {account_id} 
          had a public access policy which has been removed.
